Настройка и работа Charles Proxy

1. Установить и запустить Charles Proxy

2. Подготовка к сниффингу трафика

1) Запустить Charles Proxy и установить SSL сертификат для работы по HTTPS: 
зайти в меню Help > SSL Proxy > Install Charles Root Certificate > ОК > Установить сертификат > Импортируем сертификат.
2) Для отображения запросов в расшифрованном виде необходимо включить SSL Proxying и настроить домены, пакеты которых нужно будет перехватывать: 
в меню выбрать Proxy > SSL Proxying Settings, поставить галочку в чек-боксе Enable SSL Proxying, выбрать раздел Include, нажать Add, заполнить поле Host, написать * (можно *.*, либо []), нажать ОК > ОК.

3. Проксирование трафика веб-браузера
Чтобы увидеть запросы веб-браузера нужно в меню выбрать Proxy, нажать Windows Proxy.

4. Настройка Proxy на Android
Для сниффинга трафика мобильного устройства необходимо сделать Charles прокси сервером, через который будет идти трафик. Компьютер и телефон должны быть в одной сети Wi-Fi.
1) Для того, чтобы узнать IP-адрес и порт сети прокси-сервера Charles необходимо в программе Charles Proxy выбрать в меню 
Help > SSL Proxying > Install Charles Root Certificate on a Mobile Device or Remote Browser > ОК. 
2) Для настройки телефона перейти в Настойки > Wi-Fi > название сети > Прокси > Вручную > Имя хоста: IP-адрес компьютера (из пункта 1) > Порт: 8888 > Сохранить.
В Charles Proxy появится сообщение о попытке подключения к Charles, необходимо выбирать «Allow».
После настройки, телефон будет пропускать весь мобильный трафик через Charles Proxy.
3) Скачать и установить SSL сертификат для того, чтобы была возможность видеть расшифрованные запросы и ответы с телефона в Charles Proxy.
Необходимо запустить браузер Chrome и перейти по ссылке сhls.pro/ssl или charlesproxy.com/getssl. На экране отобразится окно, нужно заполнить поле с именем сертификата, из выпадающего списка выбрать «VPN и приложения», сохранить. 
Если возникают проблемы со скачиванием сертификата, можно перейти в режим инкогнито и через него скачать сертификат.
Для проверки, что сертификат установился зайти в настройки телефона «Надежные сертификаты» > «Пользователь».
4) Когда во время работы в Charles Proxy, интересует какой-то конкретный адрес, а весь остальной трафик не нужен, то нужно кликнуть правой кнопкой мыши по интересующему адресу и выбрать пункт «Focus». Это позволит скрыть все лишние адреса во вкладке «Other Hosts».
Для того, чтобы включить перехват трафика необходимо сделать активной кнопку Start Recording (станет красной).

5. Использование эмулятора и настройка в нем прокси-сервера
1) В Android Studio загрузить эмулятор телефона (выбрать окно AVD Manager > выбрать нужный эмулятор > запустить его).
2) Для того, чтобы настроить прокси нужно зайти в настройки эмулятора: … > Settings > Proxy > снять чек-бокс Use Android Studio HTTP Proxy Settings > выбрать Manual Proxy configuration > в поле Host name ввести IP-адрес компьютера (адрес узнать можно, зайдя в Charles Proxy, выбрав в меню Help > Local IP Addresses), в поле Post number ввести 8888 > Apply.
В Charles Proxy отобразится сообщение о попытке подключения к Charles через хост (IP адрес), выбирать «Allow».
3) Ввести в браузере эмулятора нужный сайт. Из-за того, что происходит подключение к Proxy отобразится сообщение о том, что небезопасно (нужно выбрать “Proceed to site”). Подгружаются все запросы, к которым обращается браузер, который установлен на эмуляторе. 

6. Переадресация запроса с одного хоста на другой (Map Remote).
Например, при попытке зайти на “Google” происходит перенаправление на “Yandex”.
1) В меню открыть Tools > Map Remote > поставить галочку в чек-боксе Enable Map Remote > Add > в части Map From в поле Host вставить скопированный URL, к которому нужно обратиться (например, Google.com) > на клавиатуре нажать клавишу Tab для того, чтобы произошел автоматический парсинг, все данные, которые находятся в URL распределятся автоматически (можно ввести вручную) > в части Map To в поле Host вставить скопированный URL, на который будет идти запрос (например, Yandex.by) > на клавиатуре нажать клавишу Tab > ОК > ОК.
2) Далее перейти по ссылке Google.com, автоматически происходит переадресация на Yandex.by – произошла подмена хоста.

7. Подмена данных в запросе и в ответе (Rewrite).
Можно изменять запросы и ответы, URL, отдельные параметры.
1) Замена URL
В меню открыть Tools > Rewrite > поставить галочку в чек-боксе Enable Rewrite > Add > в поле Name дать название > в Location нажать Add > в поле Host вставить скопированный URL, к которому нужно обратиться (например, Google.com) > на клавиатуре нажать клавишу Tab для того, чтобы произошел автоматический парсинг > OK >
> в Type, Action нажать Add > в поле Type открыть выпадающий список, выбрать тип, который нужен (в примере нужен URL) > в поле Match в строке Value указать, что нужно подменять (в примере Google.com) (если не указать, что нужно менять, тогда произойдет подмена всего) > в поле Replace в строке Value указать значение, на которое будет осуществляться подмена (в примере Yandex.by) > нужно выбрать, что подмена будет происходить при первом совпадении (Replace first) или заменить все (Replace All), в этом случае Replace All > OK > OK.
Далее перейти по ссылке Google.com – происходит подмена на Yandex.by – произошла подмена хоста.
2) Изменение статус-кодов 
При замене статус-кода можно смотреть что будет происходить на сервере или на клиенте.
В меню открыть Tools > Rewrite > поставить галочку в чек-боксе Enable Rewrite > Add > в поле Name дать название > в Location нажать Add > в поле Host вставить скопированный URL, к которому нужно обратиться (на примере http://users.bugred.ru/) > на клавиатуре нажать клавишу Tab для того, чтобы произошел автоматический парсинг > OK >
> в Type, Action нажать Add > в поле Type открыть выпадающий список, выбрать тип, который нужен (в примере нужен Response Status) > в поле Match нужно прописать те статус-коды, которые нужно заменить на целевые (например, 200 ОК) > в поле Replace в строке Value указать статус-код, на который нужно заменить (например, 500 Unknown Server Error) > выбрать Replace All > OK > OK.
При проверке на клиенте (на сайте) ничего не отобразится, но, если в Charles найти хост (на примере http://users.bugred.ru/) в Overview в Response Code будет отображаться 500 статус-код.

8. Замена на 403 статус-код, когда запрещен доступ (Block List)
1) В меню открыть Tools > Block List > поставить галочку в чек-боксе Enable Block List > есть две опции: можно оборвать соединение полностью (Drop connection), либо вернуть 403 ошибку (Return 403 response), в примере выбрать Return 403 response > Add > в поле Host вставить скопированный URL, который должен возвращать ошибку (на примере http://users.bugred.ru/) > на клавиатуре нажать клавишу Tab для того, чтобы произошел автоматический парсинг > OK > OK. 
На странице сайта появляется сообщение о 403 ошибке – Access forbidden. Зайти в Charles и перейти на хост (на примере http://users.bugred.ru/) в Overview в Response Code – отобразится 403 статус-код.
2) С 403 статус-кодом может работать инструмент Allow List. 
В меню открыть Tools > Allow List > поставить галочку в чек-боксе Enable Allow List > в выпадающем списке выбрать Return 403 response > если в поле Location указать адрес, то к нему это правило не будет применяться, а ко всем остальным, которых нет в списке, в результате будут 403 ошибки > Add > в поле Host вставить скопированный URL, который должен возвращать ошибку (на примере http://users.bugred.ru/) > на клавиатуре нажать клавишу Tab для того, чтобы произошел автоматический парсинг > OK > OK. 

9. Изменение тела запроса
Изменять можно body ответа, где прописан JSON, XML, картинки и т.д.
1) В меню открыть Tools > Map Local > поставить галочку в чек-боксе Enable Map Local > Add > в поле Map From в Host вставить скопированный URL (например, Google.com) > в поле Map To в Local path нужно добавить файл, который заменит тело ответа > Choose > выбрать нужный файл (например, картинка) (выбран чек-бокс Case-sensitive) > OK > OK.
При проверке на клиенте и на сервере в ответе показана картинка, которая была загружена. 
2) В меню открыть Tools > Rewrite > поставить галочку в чек-боксе Enable Rewrite > Add > в поле Name дать название > в Location нажать Add > в поле Host вставить скопированный URL, к которому нужно обратиться (на примере google.com) > на клавиатуре нажать клавишу Tab для того, чтобы произошел автоматический парсинг > OK >
> в Type, Action нажать Add > в поле Type открыть выпадающий список, выбрать тип, который нужен (наприер, Body) > в поле Match в строке Value указать, что нужно подменять (если не указать, что нужно менять, тогда произойдет подмена всего) > в поле Replace в строке Value указать значение, на которое будет осуществляться подмен > Replace All > OK > OK.

10. Перехват, изменение и отправка запроса/ответа (Breakpoints)
При перехвате запроса/ответа можно поставить в каком-либо месте брейкпоинт, который будет прерывать и после можно видоизменять запрос/ответ.
В меню открыть Proxy > Breakpoints Settings > поставить галочку в чек-боксе Enable Breakpoints > Add > в поле Scheme выбрать метод (Get или Post) > в поле Host вставить скопированный URL, к которому нужно обратиться (например, http://users.bugred.ru/) > выбрать (Request или Response) что нужно перехватывать, где нужно поставить точку, которая будет разрывать соединение (в примере Request и Response) > OK > OK.
На главной странице Charles в Edit Request можно его редактировать. После того как что-то изменено нужно нажать Execute. После изменения чего-то в запросе можно вносить изменения в ответ, после изменений нажать Execute. После этого слева пойдет много запросов. Изменения можно вносить в Headers.
